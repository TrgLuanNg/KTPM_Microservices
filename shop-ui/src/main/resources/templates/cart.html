<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Gi·ªè h√†ng c·ªßa b·∫°n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-light">
    
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4 shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">TH PHONE STORE</a>
        </div>
    </nav>

    <div class="container">
        <h2 class="mb-4 text-center text-primary fw-bold"><i class="fas fa-shopping-cart"></i> Gi·ªè h√†ng c·ªßa b·∫°n</h2>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card shadow-sm border-0">
                    <div class="card-body p-0">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>S·∫£n ph·∫©m</th>
                                    <th>ƒê∆°n gi√°</th>
                                    <th>SL</th>
                                    <th>Th√†nh ti·ªÅn</th>
                                    <th>X√≥a</th>
                                </tr>
                            </thead>
                            <tbody id="cartBody">
                                </tbody>
                        </table>
                        <div id="emptyCartMsg" class="text-center p-5 d-none">
                            <i class="fas fa-shopping-basket fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Gi·ªè h√†ng ƒëang tr·ªëng!</p>
                            <a href="/" class="btn btn-primary">Mua s·∫Øm ngay</a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white fw-bold">T√≥m t·∫Øt ƒë∆°n h√†ng</div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-3">
                            <span>T·∫°m t√≠nh:</span>
                            <span id="tempTotal" class="fw-bold">0 ƒë</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-4">
                            <span class="h5">T·ªïng c·ªông:</span>
                            <span id="finalTotal" class="h5 text-danger">0 ƒë</span>
                        </div>
                        <button class="btn btn-success w-100 py-2 fw-bold" onclick="openCheckoutModal()">
                            TI·∫æN H√ÄNH ƒê·∫∂T H√ÄNG
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="checkoutModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="fas fa-shipping-fast"></i> Th√¥ng tin giao h√†ng</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="checkoutForm">
                        <div class="mb-3">
                            <label class="form-label">H·ªç v√† t√™n</label>
                            <input type="text" id="txtName" class="form-control" placeholder="Nguy·ªÖn VƒÉn A">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                            <input type="text" id="txtPhone" class="form-control" placeholder="0988xxxxxx">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">T·ªânh / Th√†nh ph·ªë</label>
                            <select id="selProvince" class="form-select">
                                <option value="">-- Ch·ªçn T·ªânh/Th√†nh --</option>
                                </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ƒê·ªãa ch·ªâ c·ª• th·ªÉ</label>
                            <input type="text" id="txtAddressDetail" class="form-control" placeholder="S·ªë 123, ƒê∆∞·ªùng ABC...">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <div id="checkoutLoading" class="spinner-border text-success d-none" role="status"></div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-success fw-bold" onclick="confirmCheckout()">X√°c nh·∫≠n ƒê·∫∑t h√†ng</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- 1. DANH S√ÅCH 63 T·ªàNH TH√ÄNH VI·ªÜT NAM ---
        const provinces = [
            "H√† N·ªôi", "H·ªì Ch√≠ Minh", "H·∫£i Ph√≤ng", "ƒê√† N·∫µng", "C·∫ßn Th∆°",
            "An Giang", "B√† R·ªãa - V≈©ng T√†u", "B·∫Øc Giang", "B·∫Øc K·∫°n", "B·∫°c Li√™u", "B·∫Øc Ninh",
            "B·∫øn Tre", "B√¨nh ƒê·ªãnh", "B√¨nh D∆∞∆°ng", "B√¨nh Ph∆∞·ªõc", "B√¨nh Thu·∫≠n", "C√† Mau",
            "Cao B·∫±ng", "ƒê·∫Øk L·∫Øk", "ƒê·∫Øk N√¥ng", "ƒêi·ªán Bi√™n", "ƒê·ªìng Nai", "ƒê·ªìng Th√°p",
            "Gia Lai", "H√† Giang", "H√† Nam", "H√† Tƒ©nh", "H·∫£i D∆∞∆°ng", "H·∫≠u Giang",
            "H√≤a B√¨nh", "H∆∞ng Y√™n", "Kh√°nh H√≤a", "Ki√™n Giang", "Kon Tum", "Lai Ch√¢u",
            "L√¢m ƒê·ªìng", "L·∫°ng S∆°n", "L√†o Cai", "Long An", "Nam ƒê·ªãnh", "Ngh·ªá An",
            "Ninh B√¨nh", "Ninh Thu·∫≠n", "Ph√∫ Th·ªç", "Ph√∫ Y√™n", "Qu·∫£ng B√¨nh", "Qu·∫£ng Nam",
            "Qu·∫£ng Ng√£i", "Qu·∫£ng Ninh", "Qu·∫£ng Tr·ªã", "S√≥c TrƒÉng", "S∆°n La", "T√¢y Ninh",
            "Th√°i B√¨nh", "Th√°i Nguy√™n", "Thanh H√≥a", "Th·ª´a Thi√™n Hu·∫ø", "Ti·ªÅn Giang",
            "Tr√† Vinh", "Tuy√™n Quang", "Vƒ©nh Long", "Vƒ©nh Ph√∫c", "Y√™n B√°i"
        ];

        // Load t·ªânh th√†nh v√†o Select box
        const selProvince = document.getElementById("selProvince");
        provinces.sort().forEach(p => {
            let option = document.createElement("option");
            option.value = p;
            option.text = p;
            selProvince.appendChild(option);
        });

        // --- 2. X·ª¨ L√ù GI·ªé H√ÄNG ---
        let cart = JSON.parse(localStorage.getItem("CART")) || [];
        const cartBody = document.getElementById("cartBody");
        const emptyMsg = document.getElementById("emptyCartMsg");

        function renderCart() {
            cartBody.innerHTML = "";
            let total = 0;

            if (cart.length === 0) {
                emptyMsg.classList.remove("d-none");
                document.getElementById("finalTotal").innerText = "0 ƒë";
                document.getElementById("tempTotal").innerText = "0 ƒë";
                return;
            }
            
            emptyMsg.classList.add("d-none");

            cart.forEach((item, index) => {
                let subtotal = item.price * item.quantity;
                total += subtotal;
                
                cartBody.innerHTML += `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <img src="${item.image}" style="width: 50px; height: 50px; object-fit: cover; margin-right: 10px;" class="rounded">
                                <span class="fw-bold text-truncate" style="max-width: 150px;">${item.name}</span>
                            </div>
                        </td>
                        <td>${item.price.toLocaleString()} ƒë</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary" onclick="updateQty(${index}, -1)">-</button>
                                <button class="btn btn-outline-secondary" disabled>${item.quantity}</button>
                                <button class="btn btn-outline-secondary" onclick="updateQty(${index}, 1)">+</button>
                            </div>
                        </td>
                        <td class="fw-bold">${subtotal.toLocaleString()} ƒë</td>
                        <td><button class="btn btn-sm btn-outline-danger" onclick="removeItem(${index})"><i class="fas fa-trash"></i></button></td>
                    </tr>
                `;
            });
            
            let totalStr = total.toLocaleString() + " ƒë";
            document.getElementById("finalTotal").innerText = totalStr;
            document.getElementById("tempTotal").innerText = totalStr;
        }

        function updateQty(index, change) {
            if (cart[index].quantity + change > 0) {
                cart[index].quantity += change;
            }
            localStorage.setItem("CART", JSON.stringify(cart));
            renderCart();
        }

        function removeItem(index) {
            if(confirm("B·∫°n mu·ªën x√≥a s·∫£n ph·∫©m n√†y?")) {
                cart.splice(index, 1);
                localStorage.setItem("CART", JSON.stringify(cart));
                renderCart();
            }
        }

        renderCart();

        // --- 3. X·ª¨ L√ù THANH TO√ÅN ---
        const modalEl = document.getElementById('checkoutModal');
        const checkoutModal = new bootstrap.Modal(modalEl);

        function openCheckoutModal() {
            // Ki·ªÉm tra ƒëƒÉng nh·∫≠p
            let currentUser = JSON.parse(localStorage.getItem("USER_INFO"));
            if (!currentUser) {
                alert("Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi thanh to√°n!");
                window.location.href = "/"; 
                return;
            }
            if (cart.length === 0) {
                alert("Gi·ªè h√†ng tr·ªëng!");
                return;
            }

            // ƒêi·ªÅn s·∫µn t√™n n·∫øu c√≥
            document.getElementById("txtName").value = currentUser.name || "";
            checkoutModal.show();
        }

        async function confirmCheckout() {
            let currentUser = JSON.parse(localStorage.getItem("USER_INFO"));
            
            // L·∫•y d·ªØ li·ªáu t·ª´ form Modal
            const name = document.getElementById("txtName").value.trim();
            const phone = document.getElementById("txtPhone").value.trim();
            const province = document.getElementById("selProvince").value;
            const addressDetail = document.getElementById("txtAddressDetail").value.trim();

            // Validate
            if (!name || !phone || !province || !addressDetail) {
                alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin giao h√†ng!");
                return;
            }

            // Gh√©p ƒë·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß
            const fullAddress = `${addressDetail}, ${province}`;

            // T√≠nh t·ªïng ti·ªÅn
            let finalTotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);

            // T·∫°o object Order ƒë·ªÉ g·ª≠i ƒëi
            const orderData = {
                userId: currentUser.id,
                customerName: name,
                customerPhone: phone,
                customerAddress: fullAddress, // <--- ƒê·ªäA CH·ªà ƒê∆Ø·ª¢C G·ª¨I ·ªû ƒê√ÇY
                totalPrice: finalTotal,
                productListJson: JSON.stringify(cart)
            };

            // Hi·ªáu ·ª©ng loading
            document.getElementById("checkoutLoading").classList.remove("d-none");

            try {
                // G·ªçi API t·∫°o ƒë∆°n h√†ng (Order Service - 8083)
                // D√πng APP_BACKEND_URL ƒë√£ c·∫•u h√¨nh kh√¥ng ƒë∆∞·ª£c v√¨ ƒë√¢y l√† Client-side JS
                // Ta g·ªçi tr·ª±c ti·∫øp t·ªõi localhost:8083 (ho·∫∑c qua Gateway n·∫øu c√≥)
                const response = await fetch("http://localhost:8083/api/orders", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(orderData)
                });

                if (response.ok) {
                    checkoutModal.hide();
                    localStorage.removeItem("CART"); // X√≥a gi·ªè h√†ng
                    cart = [];
                    renderCart();
                    
                    // Th√¥ng b√°o ƒë·∫πp
                    alert(`üéâ ƒê·∫∑t h√†ng th√†nh c√¥ng!\nƒê∆°n h√†ng s·∫Ω ƒë∆∞·ª£c giao t·ªõi: ${fullAddress}`);
                    window.location.href = "/";
                } else {
                    alert("C√≥ l·ªói x·∫£y ra khi t·∫°o ƒë∆°n h√†ng!");
                }
            } catch (err) {
                console.error(err);
                alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi Order Service! (Ki·ªÉm tra xem service 8083 c√≥ ch·∫°y kh√¥ng)");
            } finally {
                document.getElementById("checkoutLoading").classList.add("d-none");
            }
        }
    </script>
</body>
</html>